export const EVENT_LOG_PROMPT =
  '你是一个从文本中抽取原子化事件日志的助手。\n\n' +
  '输入文本：\n{{INPUT_TEXT}}\n\n' +
  '当前时间：{{TIME}}\n\n' +
  '任务：从输入文本中抽取有信息量的原子事件。每个事件需包含具体时间和原子事实列表。\n\n' +
  '**重要过滤规则：**\n' +
  '- 原子事实必须是有实质信息量的、可验证的事实\n' +
  '- 不要记录"用户打招呼"、"用户问好"、"AI回复了用户"等无实质内容的交互\n' +
  '- 不要将 AI 的状态播报或模板化回复作为事实记录\n' +
  '- 只记录用户实际做出的有意义的行为、决策、请求或表达的观点\n\n' +
  '返回如下结构的 JSON 对象（键名保持英文）：\n' +
  '{\n' +
  '  "event_log": {\n' +
  '    "time": "YYYY-MM-DD",\n' +
  '    "atomic_fact": [\n' +
  '      "事实1",\n' +
  '      "事实2"\n' +
  '    ]\n' +
  '  }\n' +
  '}\n' +
  '若未发现有信息量的事件，则 atomic_fact 返回空数组。\n'

export const FORESIGHT_GENERATION_PROMPT =
  '你是一个根据对话预测潜在未来影响（前瞻）的助手。\n\n' +
  '对话内容：\n{{CONVERSATION_TEXT}}\n\n' +
  '任务：分析对话并预测最多 10 条与用户相关的潜在未来影响或信息。\n\n' +
  '**重要过滤规则：**\n' +
  '- 前瞻必须基于用户在对话中明确表达或强烈暗示的意图、需求或计划\n' +
  '- 不可仅基于 AI 单方面提供的信息（如工作区状态播报、功能介绍）来推测用户下一步行为\n' +
  '- 不可基于打招呼/寒暄等无实质内容的对话进行推测\n' +
  '- 每条前瞻的 evidence 必须引用用户自己的话语或明确行为，而非 AI 的回复\n' +
  '- 如果对话中没有足够的用户意图信息，返回空数组 []\n\n' +
  '返回如下结构的 JSON 数组（键名保持英文）：\n' +
  '[\n' +
  '  {\n' +
  '    "content": "前瞻描述",\n' +
  '    "evidence": "支撑该条的前文引用（必须来自用户发言）",\n' +
  '    "start_time": "YYYY-MM-DD",\n' +
  '    "end_time": "YYYY-MM-DD（可选）",\n' +
  '    "duration_days": 1（可选）\n' +
  '  }\n' +
  ']\n' +
  '若对话无法支撑有效前瞻，返回空数组 []。\n'

export const EPISODE_MEMORY_PROMPT =
  '你是一个将对话归纳为情景记忆的助手。\n\n' +
  '输入文本：\n{{INPUT_TEXT}}\n\n' +
  '当前时间：{{TIME}}\n\n' +
  '任务：概括对话，抽取关键信息、关键词和一句摘要。\n\n' +
  '**重要过滤规则：**\n' +
  '- 如果对话仅是打招呼、寒暄、简单问候（如"你好"、"在吗"），不含有实质性话题讨论，返回空对象 {}\n' +
  '- AI 单方面的自我介绍、状态播报不构成有价值的情景记忆\n' +
  '- 摘要应聚焦于用户的具体需求、决策、讨论内容，而非 AI 的回应模板\n\n' +
  '返回如下 JSON 对象（键名保持英文）：\n' +
  '{\n' +
  '  "title": "情景标题",\n' +
  '  "content": "完整详细摘要",\n' +
  '  "summary": "一句话简要摘要",\n' +
  '  "keywords": ["标签1", "标签2"]\n' +
  '}\n' +
  '若对话无实质内容，返回 {} 空对象。\n'

/** 单次调用完成 episode / event_log / foresight / profile 抽取，使用分段文本格式（非 JSON）。与分类型抽取语义等价；小节标题与键名必须保持英文以便解析。 */
export const UNIFIED_MEMORY_EXTRACTION_PROMPT =
  '你是记忆抽取专家，从对话中一次性完成四类抽取：情景记忆、事件日志、前瞻、用户画像。当前时间：{{TIME}}\n\n' +
  '<input>\n对话内容：\n{{INPUT_TEXT}}\n</input>\n\n' +
  '<quality_gate>\n' +
  '**在抽取前，先判断对话是否包含有记忆价值的实质内容。以下场景不应产生任何记忆（直接输出空文本）：**\n' +
  '- 没有特殊情境的纯寒暄/打招呼（如"你好"、"在吗"、"hi"）\n' +
  '- AI 单方面的自我介绍、状态播报、能力说明（用户未做任何实质性请求或表达）\n' +
  '- 对话仅包含系统自动消息或模板化回复，没有用户的主动意图表达\n\n' +
  '**有效记忆的最低标准：对话中必须存在用户的具体需求、观点、决策、经历描述或有信息量的交互。**\n' +
  '</quality_gate>\n\n' +
  '<format_convention>\n' +
  '1. 小节标题：仅使用以下四者之一单独占一行，不可翻译或改写：## EPISODE、## EVENT_LOG、## FORESIGHT、## PROFILE。无内容的小节整节省略。\n' +
  '2. 键值行：每行一条，格式为「英文键名: 值」。键名与值之间用英文冒号+空格分隔；值可含中文或冒号，但整条不换行。\n' +
  '3. FORESIGHT 多条之间用单独一行「---」分隔；不要在 CONTENT 或 EVIDENCE 的正文中写入「---」。\n' +
  '4. 对话中 role=user 的一方即为「用户」，role=assistant 为 AI 助手。\n' +
  '</format_convention>\n\n' +
  '<output_format>\n' +
  '## EPISODE\n（完整详细摘要、一句话摘要、关键词。注意：摘要应聚焦于用户的行为和意图，而非 AI 的回应模板）\n' +
  'CONTENT: <完整详细摘要，一行>\nSUMMARY: <一句话简要摘要>\nKEYWORDS: k1, k2\n\n' +
  '## EVENT_LOG\n（具体时间 + 原子事实列表；原子事实为可验证、不可再分的、有信息量的单一事实）\n' +
  'TIME: YYYY-MM-DD\nFACT: <原子事实一>\nFACT: <原子事实二>\n\n' +
  '## FORESIGHT\n（用户明确表达或强烈暗示的意图推导出的未来可能行为；必须有对话中的具体证据支撑）\n' +
  'CONTENT: <前瞻描述>\nSTART: YYYY-MM-DD\nEND: YYYY-MM-DD\nEVIDENCE: <支撑该条的前文引用>\n---\nCONTENT: <下一条>\n\n' +
  '## PROFILE\n（用户**持久性**个人画像：仅提取能跨会话复用的、反映"用户是谁"的个性化信息）\n' +
  '**已有画像：** {{EXISTING_PROFILE}}\n' +
  '**重要：仅提取本次对话中出现的、已有画像中尚未包含的新增信息。已有画像中已记录的内容请勿重复输出。**\n' +
  '**原子化描述：每条 ITEM 仅描述一个独立事实，不可将多个事实合并到一条中。**\n\n' +
  '可参考的画像维度（仅作为观察方向，不要求每个都填，仅输出对话中有依据的）：\n' +
  '  · 称呼/名字 — 用户希望怎样被称呼\n' +
  '  · 硬技能 — 编程语言、框架、工具、专业领域及熟练度\n' +
  '  · 软技能 — 沟通、协作、领导力等\n' +
  '  · 性格特点 — 内向/外向、乐观/谨慎、幽默风格等\n' +
  '  · 决策风格 — 数据驱动、直觉型、共识型等\n' +
  '  · 职业角色与职责 — 岗位、团队角色、日常工作内容\n' +
  '  · 目标与动机 — 长期职业目标、学习方向、核心驱动力\n' +
  '  · 兴趣爱好 — 非工作领域的持久兴趣\n' +
  '  · 工作习惯与偏好 — 时间偏好、工具偏好、协作方式、审美倾向\n' +
  '  · 价值观与倾向 — 技术选型偏好、审美取向、处事原则\n' +
  '  · 恐惧/顾虑 — 明确表达的担忧或回避事项\n\n' +
  '❌ 不应提取（临时动作）：本次对话的具体请求、一次性操作需求、对工具功能的使用、通用能力描述、对话中的临时状态\n' +
  '❌ 不应提取（已知信息）：已有画像中已记录的信息，即使本次对话再次提及也不输出\n' +
  '判断标准：如果换一个用户也可能提出同样的请求，那就不是画像；画像必须是**这个用户独有的、持久的**特征。\n' +
  'ITEM: <关于用户的一条原子事实，如"用户希望被称为老大">\n' +
  'ITEM: <另一条原子事实，如"用户熟练使用 TypeScript，偏好函数式风格">\n' +
  'ITEM: <再一条，如"用户特别喜爱周杰伦的音乐">\n' +
  '（每条 ITEM 只描述一个维度：一个称呼、一个偏好、一项技能、一个习惯等，不可用逗号或"并且"串联多个事实）\n' +
  '</output_format>\n\n' +
  '<rules>\n' +
  '1. 键名必须为上述英文（CONTENT/SUMMARY/KEYWORDS/TIME/FACT/START/END/EVIDENCE/ITEM），不要输出 USER_NAME 等未列出的键。\n' +
  '2. EVENT_LOG：FACT 最多 10 条；无事件则省略 ## EVENT_LOG。FACT 必须是有信息量的事实，不得包含"用户打招呼"、"用户问好"、"AI回复了用户"等无实质内容的记录。\n' +
  '3. FORESIGHT：最多 10 条，条与条之间用单独一行 --- 分隔；每条必须有 EVIDENCE 且证据来自用户的明确表达。不可仅基于 AI 单方面提供的信息（如 AI 播报的工作区状态）来推测用户意图。\n' +
  '4. PROFILE（高门槛 + 增量原则）：仅提取反映用户持久个性特征的**新增**信息，严格过滤以下噪音：\n' +
  '   - ❌ 当次对话的操作请求（如"用户需要管理文件""用户想搜索记忆"）→ 这是 EVENT_LOG 而非画像\n' +
  '   - ❌ 对工具/系统功能的使用（如"用户使用了便签功能""用户查看了文档"）→ 行为日志，不是画像\n' +
  '   - ❌ 从 AI 回复或系统上下文推断的信息（如"用户的工作区有3个便签"）→ 不是用户自述\n' +
  '   - ❌ 任何人都可能有的通用描述（如"用户有操作需求""用户会编程"）→ 无个性化区分度\n' +
  '   - ❌ 已有画像中已记录的信息 → 即使本次对话再次提及也不输出，避免重复\n' +
  '   - ✅ 仅保留：上方维度列表中有对话证据支撑的持久特征（称呼、技能、性格、兴趣、习惯、价值观等）\n' +
  '   每条 ITEM 必须是原子描述（一条一事实），严禁用逗号或"并且"合并多个事实。无**新增**高质量画像信息时整段省略。\n' +
  '5. EPISODE：摘要必须反映有意义的交互内容。如果对话的实质只是打招呼或闲聊而无具体话题展开，则省略整个 ## EPISODE 段。\n' +
  '6. 宁可不产出记忆，也不要产出低质量/无信息量的记忆。对话信息量不足时，输出空文本即可。\n' +
  '</rules>'

/**
 * 语义去重 LLM 确认 prompt（轻量级）。
 * 用于向量距离命中后，由 LLM 二次判断两条记忆是否真的表达相同信息。
 * LLM 仅需回答一行：SAME 或 DIFF + 理由。
 */
export const DEDUP_CONFIRM_PROMPT =
  '判断以下两条记忆是否表达了相同的核心信息（仅措辞不同、时间不同、或细节略有增减，但核心语义等价）。\n\n' +
  '已存储记忆:\n{{EXISTING}}\n\n新抽取记忆:\n{{NEW}}\n\n' +
  '回答格式仅一行: SAME 或 DIFF，空格后跟一句理由。\n' +
  '示例:\n' +
  'SAME 两条都描述用户希望被称为老大\n' +
  'DIFF 新记忆涉及用户的新项目需求，与已有记忆的主题不同\n'

/** Agentic 检索用：将用户 query 扩展为 2～3 条子查询（不同表述或子问题） */
export const QUERY_EXPANSION_PROMPT =
  '针对下列用户问题，生成 2～3 种不同表述或子问题，用于从记忆库中检索相关信息。' +
  '仅返回 JSON 字符串数组，不要其他文字。示例：["问题1", "问题2"]。\n用户问题：{{QUERY}}'

/** Agentic 检索：LLM 判断检索结果是否充分回答用户查询 */
export const SUFFICIENCY_CHECK_PROMPT =
  '你是一个记忆检索评估专家。请判断当前检索到的记忆是否足以回答用户的查询。\n\n' +
  '用户查询：\n{{QUERY}}\n\n' +
  '检索到的记忆：\n{{RETRIEVED_DOCS}}\n\n' +
  '请判断这些记忆是否足以回答用户的查询。\n\n' +
  '输出 JSON 格式：\n' +
  '{\n' +
  '  "is_sufficient": true/false,\n' +
  '  "reasoning": "你的判断理由",\n' +
  '  "missing_information": ["缺失信息1", "缺失信息2"]\n' +
  '}\n\n' +
  '要求：\n' +
  '1. 如果记忆包含回答查询所需的关键信息，判断为 sufficient (true)\n' +
  '2. 如果缺少关键信息，判断为 insufficient (false)，并列出缺失的信息\n' +
  '3. reasoning 应简明扼要\n' +
  '4. missing_information 仅在 insufficient 时填写，otherwise 空数组\n'

/** Agentic 检索：基于缺失信息生成 2-3 条补充查询 */
export const REFINED_QUERY_PROMPT =
  '你是一个查询优化专家。用户的原始查询未能检索到足够的信息，请生成多条互补的改进查询。\n\n' +
  '原始查询：\n{{ORIGINAL_QUERY}}\n\n' +
  '当前检索到的记忆：\n{{RETRIEVED_DOCS}}\n\n' +
  '缺失的信息：\n{{MISSING_INFO}}\n\n' +
  '请生成 2-3 条互补查询来帮助找到缺失的信息。这些查询应当：\n' +
  '1. 针对不同的缺失信息点\n' +
  '2. 使用不同的表述方式\n' +
  '3. 避免与原始查询完全相同\n' +
  '4. 保持简洁明确\n\n' +
  '输出 JSON 格式：\n' +
  '{\n' +
  '  "queries": ["改进查询1", "改进查询2", "改进查询3"],\n' +
  '  "reasoning": "查询生成策略说明"\n' +
  '}\n'

/**
 * 文档记忆抽取 prompt（文档创建/更新时使用）。
 * 输出两段：OVERVIEW（总览记忆，仅 1 条）+ FACTS（原子事实记忆，多条）。
 * 针对低维向量模型（<400 维）优化：每条记忆独立可检索，不依赖上下文。
 */
export const DOCUMENT_MEMORY_EXTRACTION_PROMPT =
  '你是文档记忆抽取专家，从文档内容中提取结构化记忆条目。当前时间：{{TIME}}\n\n' +
  '<input>\n文档标题：{{TITLE}}\n\n文档内容：\n{{INPUT_TEXT}}\n</input>\n\n' +
  '<format_convention>\n' +
  '1. 小节标题：仅使用 ## OVERVIEW 或 ## FACTS，单独占一行，不可翻译或改写。无内容的小节整节省略。\n' +
  '2. 键值行：每行一条，格式为「英文键名: 值」。键名与值之间用英文冒号+空格分隔。\n' +
  '</format_convention>\n\n' +
  '<output_format>\n' +
  '## OVERVIEW\n' +
  '（文档总览：一段 200-400 字的详细摘要，涵盖文档主题、结构、核心论点和关键结论。' +
  '应当让读者无需阅读原文即可了解文档全貌。）\n' +
  'CONTENT: <文档总览，一行，200-400 字>\n\n' +
  '## FACTS\n' +
  '（从文档中提取的原子事实列表。每条事实必须：' +
  '1）独立可理解，不依赖上下文；' +
  '2）包含足够的主语和限定词，如「文档《X》中提到 Y」；' +
  '3）不超过 80 字。）\n' +
  'FACT: <原子事实一>\n' +
  'FACT: <原子事实二>\n' +
  '</output_format>\n\n' +
  '<rules>\n' +
  '1. 键名必须为英文：CONTENT、FACT。\n' +
  '2. OVERVIEW 必须输出且仅 1 条 CONTENT。总览应准确反映文档核心内容，不可遗漏重要信息。\n' +
  '3. FACTS 中的 FACT 最多 20 条。提取文档中的关键事实、数据、定义、结论、要点。\n' +
  '4. 每条 FACT 必须是原子的（不可再分的单一事实），包含足够的上下文使其可被独立检索和理解。\n' +
  '5. 避免提取过于宽泛或无信息量的内容（如"文档讨论了某个话题"）。\n' +
  '6. 文档内容过短或无实质信息时，OVERVIEW 简短概括即可，FACTS 可省略。\n' +
  '</rules>'

/**
 * 文档迁移记忆抽取 prompt（文档更新时使用）。
 * 从文本 diff 中提取语义层面的变更条目。
 */
export const DOCUMENT_MIGRATION_PROMPT =
  '你是文档变更分析专家，从文档更新的 diff 中提取有意义的语义变更记录。当前时间：{{TIME}}\n\n' +
  '<input>\n文档标题：{{TITLE}}\n\n' +
  '{{OLD_OVERVIEW_SECTION}}' +
  '本次更新的文本差异：\n{{DIFF_TEXT}}\n</input>\n\n' +
  '<output_format>\n' +
  '## MIGRATION\n' +
  '（本次更新的语义变更列表。每条 CHANGE 描述一个有意义的变更，如新增了什么内容、修改了什么定义、删除了什么章节。）\n' +
  'CHANGE: <语义变更描述一>\n' +
  'CHANGE: <语义变更描述二>\n' +
  '</output_format>\n\n' +
  '<rules>\n' +
  '1. 键名必须为英文：CHANGE。\n' +
  '2. 每条 CHANGE 不超过 100 字，应当包含文档标题引用和具体变更内容。\n' +
  '3. CHANGE 最多 10 条。聚焦于有实质意义的变更，忽略格式调整、拼写修正等琐碎改动。\n' +
  '4. 变更描述应当独立可理解，如「文档《X》新增了关于 Y 的结论」而非「新增了一段内容」。\n' +
  '5. 若 diff 中无有意义的语义变更（如仅格式调整），输出空文本即可。\n' +
  '</rules>'

/**
 * Profile 增量合并 prompt：LLM 智能合并新旧画像。
 *
 * 输入/输出格式均为：
 *   { "items": ["原子事实1", "原子事实2"] }
 *
 * LLM 负责：items 语义去重、冲突解决。
 */
export const PROFILE_MERGE_PROMPT =
  '你是用户画像合并专家。请将新抽取的用户画像信息增量合并到已有画像中。\n\n' +
  '已有画像：\n{{EXISTING_PROFILE}}\n\n' +
  '新抽取画像：\n{{INCOMING_PROFILE}}\n\n' +
  '合并规则：\n' +
  '1. items（原子事实列表）：\n' +
  '   - 语义相同的条目只保留一个（如「喜欢 TS」和「喜欢 TypeScript」合并为一条）\n' +
  '   - 新旧互补的条目全部保留\n' +
  '   - 有矛盾的条目，优先保留新信息（用户最新表达）\n' +
  '2. 不要丢失任何已有的有效信息\n\n' +
  '输出严格 JSON 格式：\n' +
  '{\n' +
  '  "merged_profile": {\n' +
  '    "items": ["合并去重后的原子事实1", "原子事实2", ...]\n' +
  '  },\n' +
  '  "changes_summary": "一句话描述合并了什么"\n' +
  '}\n'
