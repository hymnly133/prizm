# 新用户动线检查报告

从「启动服务端 → 启动客户端 → 首次连接与注册」的交互、视觉与逻辑链路检查，评估是否直接、直观、方便。

---

## 1. 当前链路概览

| 阶段 | 行为 | 现状 |
|------|------|------|
| **服务端启动** | `yarn dev:server` / `yarn start` | CLI 输出 `Server running at http://127.0.0.1:4127`、`Dashboard: .../dashboard/`，根路径 `/` 重定向到 `/dashboard/`。 |
| **浏览器首次访问** | 打开 `http://127.0.0.1:4127/` | 直接进入控制台（Panel），带 `X-Prizm-Panel: true` 免鉴权，可查看概览、便签、任务等。 |
| **桌面端首次启动** | `yarn dev:electron` | 无配置或 `api_key` 为空时，`init()` 后 `setActivePage('settings')`，进入设置页；若满足条件则展示 **OnboardingWizard**（三步：连接服务器 → 注册客户端 → 完成）。 |
| **引导内连接失败** | 未启动服务端时点「测试连接」 | 提示「无法连接到服务器，请检查地址和端口」，未明确说明需先启动服务端。 |
| **引导完成** | 点击「开始使用」 | `window.location.reload()` 全量刷新，随后带 `api_key` 正常连接。 |

---

## 2. 发现的问题与改进建议

### 2.1 客户端首次加载：先闪首页再跳设置（体验不直接）

- **现象**：首次打开 Electron 时，先渲染一次首页（仪表盘），约一帧后 `init()` 里 `loadConfig()` 完成，发现无 `api_key` 再 `setActivePage('settings')`，用户会看到短暂「首页 → 设置页」的跳转。
- **建议**：在未完成「是否需要引导」判断前，不展示主导航与首页；可二选一：
  - **方案 A**：初始 `activePage` 设为 `'settings'`，仅当确认已有 `api_key` 且连接成功后再切到 `'home'`；或
  - **方案 B**：增加「初始化中」状态（如 `initStatus: 'pending' | 'ready'`），在 `pending` 时只显示简短加载或占位，待 `init()` 结束后再根据是否需要配置决定展示设置/引导或首页。

### 2.2 引导内连接失败：未提示「先启动服务端」（不直观）

- **现象**：新用户未先启动服务端就打开客户端，在 Onboarding 第一步填好 127.0.0.1:4127 并点「测试连接」，得到「无法连接到服务器，请检查地址和端口」。
- **建议**：连接失败时在错误提示或表单下方增加一句明确指引，例如：「请确认 Prizm 服务端已启动（在本机可运行 `yarn dev:server` 或 `yarn start`）。」

### 2.3 服务端启动日志：未提示桌面端如何连接（可更直观）

- **现象**：CLI 只打印 Dashboard 地址，新用户可能不知道桌面客户端要填的正是该地址。
- **建议**：在启动成功日志中增加一行，例如：「桌面客户端连接：在客户端设置中使用上述地址与端口（默认 127.0.0.1:4127）。」

### 2.4 其他（已较合理）

- **Panel 首次访问**：根路径重定向到 `/dashboard/`，带 Panel 头免鉴权，逻辑清晰。
- **Onboarding 三步**：连接 → 注册 → 完成，步骤清晰；默认 127.0.0.1:4127 与 README 一致。
- **文档**：README / USER_GUIDE 已说明先启动服务端、再启动客户端及首次注册 API Key 的方式，与实现一致。

---

## 3. 逻辑链路小结

| 检查项 | 结论 |
|--------|------|
| 服务端启动后是否有明确入口 | ✅ 有：CLI 打印地址 + 根路径重定向 Dashboard；可加强一句「桌面端连接」说明。 |
| 新用户是否会被引导到连接/注册 | ✅ 会：无 `api_key` 时进入设置并展示 OnboardingWizard。 |
| 连接失败是否有可操作指引 | ⚠️ 有提示但未提「先启动服务端」，建议补一句。 |
| 首次加载是否避免多余跳转 | ❌ 会先闪首页再进设置，建议在 init 完成前不展示首页或默认进设置。 |
| 视觉与步骤是否清晰 | ✅ 引导三步、默认地址、完成即刷新，整体清晰。 |

---

## 4. 建议实施顺序

1. **高**：客户端首次加载——避免「先首页再设置」的闪烁（方案 A 或 B）。
2. **高**：Onboarding 连接失败——增加「请先启动 Prizm 服务端」类提示。
3. **中**：服务端 CLI——增加一行桌面端连接提示。

以上改动不改变现有 API 与配置结构，仅优化新用户的首次体验与认知路径。

---

## 5. 已实现的自动化（后续补充）

| 能力 | 说明 |
|------|------|
| **服务端 `--open`** | 启动时加 `--open` 或 `-o`，自动用系统默认浏览器打开 Dashboard（`http://{host}:{port}/dashboard/`）。 |
| **引导页自动检测** | 进入「连接服务器」步骤时，自动请求当前填写的地址/端口的 `/health`；若成功则标记为已连接并 toast 提示，用户可直接点「下一步」或「一键连接并注册」。 |
| **一键连接并注册** | 当检测到服务端或手动测试连接成功后，出现「一键连接并注册」按钮；点击后依次执行：测试连接 → 注册客户端 → 保存配置并刷新，一步完成首次配置。 |
