# Agent 对话系统 — 客户端功能测试清单

> 在 Prizm Electron 客户端的 **Agent 对话页面** 中逐一执行以下场景。
> 每个场景标注了输入内容、操作步骤和检查点（checkbox），可以边测试边打勾。

---

## 场景 1：基本对话（冒烟测试）

**操作**：点击新建会话，在输入框中输入并发送：

```
你好，请用一句话介绍你自己
```

**检查**：
- [ ] 消息气泡正常显示用户消息和助手回复
- [ ] 左侧会话列表出现新会话，标题为自动生成的摘要（如"自我介绍"）
- [ ] 底部 done 事件包含 model 和 usage 信息
- [ ] 无报错、无卡死

---

## 场景 2：工具调用 — 创建待办

**输入**：

```
帮我创建一个待办列表叫"本周计划"，添加三个任务：写周报、代码 review、整理文档
```

**检查**：
- [ ] 消息中出现工具调用卡片（`prizm_todo`），状态从 preparing → running → done
- [ ] 工具返回结果显示列表已创建，包含 3 个条目
- [ ] 切换到「工作」页面，确认「本周计划」待办列表存在且有 3 条任务

---

## 场景 3：工具调用 — 文档 CRUD

**第一条**：

```
帮我创建一个文档，标题"会议纪要 2026-02"，内容写上：讨论了 Q1 目标和资源分配
```

**第二条**：

```
帮我在刚创建的文档末尾追加一段：下次会议安排在 3 月 1 日
```

**第三条**：

```
列出所有文档
```

**检查**：
- [ ] 第一条：`prizm_document` action:create 工具卡片出现
- [ ] 第二条：`prizm_document` action:update 工具卡片出现
- [ ] 第三条：返回结果中包含「会议纪要 2026-02」
- [ ] 文档页面可以看到创建的文档，且内容包含追加内容

---

## 场景 4：工具调用 — 文件操作

**输入**：

```
请列出当前工作区根目录下的文件
```

**检查**：
- [ ] `prizm_file` action:list 工具卡片出现
- [ ] 返回结果包含工作区文件/目录列表

---

## 场景 5：工具调用 — 终端执行

**输入**：

```
请执行命令 echo Hello Prizm
```

**检查**：
- [ ] `prizm_terminal_execute` 工具卡片出现
- [ ] 返回结果包含 `Hello Prizm`

---

## 场景 6：工具调用 — 搜索

> 前置：先完成场景 3（创建了"会议纪要"文档）

**输入**：

```
搜索一下工作区里有没有和"会议"相关的内容
```

**检查**：
- [ ] `prizm_search` action:keyword 工具卡片出现
- [ ] 搜索结果中包含「会议纪要 2026-02」

---

## 场景 7：工具调用 — 知识库/记忆查询

**输入**：

```
用知识库搜索一下"待办"相关的记忆
```

**检查**：
- [ ] `prizm_knowledge` action:search 工具卡片出现
- [ ] 返回记忆条目（如果之前有创建过内容）或提示无相关记忆

---

## 场景 8：停止生成

**操作**：输入一个需要较长回复的问题：

```
请详细介绍 TypeScript 的类型系统，包括泛型、条件类型、映射类型、模板字面量类型，每个都举例说明
```

**然后立即点击输入框旁的停止按钮（■）**

**检查**：
- [ ] 生成立即停止
- [ ] 已生成的部分内容被保留并正常显示
- [ ] 可以继续发送新消息（会话未损坏）
- [ ] 停止后不会再有新的文本流入

---

## 场景 9：Slash 命令

**依次输入以下命令（每条单独发送）**：

```
/help
```

```
/stats
```

```
/todos
```

```
/docs
```

**检查**：
- [ ] `/help` 返回可用命令列表
- [ ] `/stats` 返回工作区统计数据（文档数、待办数、字数等）
- [ ] `/todos` 列出所有待办（包含场景 2 创建的）
- [ ] `/docs` 列出所有文档（包含场景 3 创建的）
- [ ] 以上命令均立即返回，无 LLM 流式输出等待

---

## 场景 10：多轮对话连贯性

**在同一会话中连续发送三条**：

第一条：

```
我正在做一个 React 项目
```

第二条：

```
项目用了 TypeScript 和 Zustand
```

第三条：

```
帮我总结一下我刚才说的项目技术栈
```

**检查**：
- [ ] 第三轮回复正确引用了前两轮的信息（React + TypeScript + Zustand）
- [ ] 会话摘要随最新消息更新
- [ ] 上下文未丢失

---

## 场景 11：记忆系统验证

### 步骤 A — 建立记忆

在**会话 1** 中发送：

```
记住我的名字叫小明，我是后端开发工程师，最常用的语言是 Go
```

**等待 3~5 秒**让记忆提取完成。

### 步骤 B — 验证注入

**新建会话 2**，发送：

```
你还记得我的名字和职业吗？
```

**检查**：
- [ ] 会话 2 中出现「记忆已注入」提示（memory_injected 事件）
- [ ] 助手正确回忆出"小明"、"后端开发"或"Go"
- [ ] 可查看注入的记忆详情（点击记忆标签）

---

## 场景 12：资源锁（文档签出/签入）

> 前置：需要已存在一个文档（场景 3 已创建"会议纪要"）

**第一条**：

```
帮我签出"会议纪要"文档进行编辑
```

**第二条**：

```
把文档内容改成"Q1 计划已确认，下次会议 3 月 5 日"
```

**第三条**：

```
编辑完毕，请释放文档锁
```

**检查**：
- [ ] 第一条：`prizm_lock` action:checkout 工具卡片
- [ ] 第二条：`prizm_document` action:update 工具卡片
- [ ] 第三条：`prizm_lock` action:checkin 工具卡片
- [ ] 文档内容已更新为新内容

---

## 场景 13：Checkpoint 与回退

**步骤 A** — 发送消息创建 checkpoint：

第一条：

```
请创建一个文档标题"测试回退"，内容写"原始内容"
```

第二条：

```
请把"测试回退"文档的内容改成"修改后的内容"
```

**步骤 B** — 回退操作：
- 在消息时间线中找到第一条消息的 checkpoint 标记
- 点击回退到该 checkpoint

**检查**：
- [ ] 回退后，第二条及之后的消息被移除
- [ ] 「测试回退」文档内容恢复为"原始内容"（如果选择了恢复文件）
- [ ] 回退后可以继续正常发送新消息

---

## 场景 14：文件引用（@ 引用）

**操作**：在输入框中使用 `@` 引用功能选择一个文件，然后发送：

```
@package.json 请分析这个文件的依赖结构
```

（`@` 后应触发文件选择下拉菜单，选择目标文件）

**检查**：
- [ ] 输入框中文件引用以 tag 形式显示
- [ ] 发送后助手能基于文件内容进行分析
- [ ] session 的 grantedPaths 被更新（可通过 `/context` 命令验证）

---

## 场景 15：临时工作区（session workspace）

**第一条**：

```
请在临时工作区创建一个文档，标题"草稿"，内容"这是一个草稿文档"
```

**第二条**：

```
列出临时工作区的文档
```

**第三条**：

```
列出主工作区的文档
```

**检查**：
- [ ] 第一条：`prizm_document` 工具使用 workspace="session"
- [ ] 第二条：结果中包含"草稿"
- [ ] 第三条：结果中不包含"草稿"（在主工作区中不可见）

---

## 场景 16：后台任务（spawn_task）

**输入**：

```
请派发一个后台子任务：统计当前工作区有多少个文档和多少个待办列表，并返回结果
```

**检查**：
- [ ] `prizm_spawn_task` 工具卡片出现
- [ ] 后台任务面板中出现新任务
- [ ] 任务最终完成，可查看结果

---

## 场景 17：日程管理

**输入**：

```
帮我创建一个日程：明天上午 10 点开会，提前 15 分钟提醒
```

**检查**：
- [ ] `prizm_schedule` action:create 工具卡片出现
- [ ] 工具返回日程创建成功，包含日程 ID
- [ ] 日程页面中出现新日程

---

## 场景 18：工作流

**输入**：

```
注册一个工作流，名称叫"文档审核流"，包含两步：第一步由 agent 生成文档摘要，第二步需要人工审批
```

**检查**：
- [ ] `prizm_workflow` action:register 工具卡片出现
- [ ] 返回工作流注册成功信息

---

## 场景 19：定时任务

**输入**：

```
创建一个定时任务：每天早上 9 点检查待办列表并发送提醒
```

**检查**：
- [ ] `prizm_cron` action:create 工具卡片出现
- [ ] 返回 cron job 创建成功信息，包含 job ID

---

## 场景 20：错误处理与边界情况

### 20a — 空消息

尝试不输入任何内容直接按回车/点击发送。

- [ ] 空消息被客户端拦截，不发送

### 20b — 超长消息

粘贴一段 5000+ 字的文本发送。

- [ ] 长文本正常发送
- [ ] 助手正常回复（可能需要更长等待）
- [ ] 无截断或崩溃

### 20c — 快速连续发送

在回复过程中（正在生成时），尝试再次快速点击发送。

- [ ] 发送按钮被禁用或消息正确排队
- [ ] 不出现消息重复或丢失

### 20d — 网络中断

发送消息过程中关闭服务器（终端中 Ctrl+C 停止 `yarn dev:server`）。

- [ ] 客户端显示错误提示（如连接断开）
- [ ] 不崩溃
- [ ] 重新启动服务器后可恢复正常使用

---

## 测试完成总结

| 场景 | 描述 | 通过 |
|------|------|------|
| 1 | 基本对话 | |
| 2 | 待办 CRUD | |
| 3 | 文档 CRUD | |
| 4 | 文件列出 | |
| 5 | 终端执行 | |
| 6 | 搜索 | |
| 7 | 知识库查询 | |
| 8 | 停止生成 | |
| 9 | Slash 命令 | |
| 10 | 多轮连贯性 | |
| 11 | 记忆系统 | |
| 12 | 资源锁 | |
| 13 | Checkpoint 回退 | |
| 14 | 文件引用 | |
| 15 | 临时工作区 | |
| 16 | 后台任务 | |
| 17 | 日程管理 | |
| 18 | 工作流 | |
| 19 | 定时任务 | |
| 20 | 错误/边界 | |
